#! /usr/bin/env python3
# Query CVE data

import argparse, datetime, json

# import couchdb # Deprecated https://github.com/djc/couchdb-python
# Use instead https://github.com/IBM/cloudant-python-sdk
from ibmcloudant.cloudant_v1 import CloudantV1
from ibm_cloud_sdk_core.authenticators import BasicAuthenticator

from pygnuplot import gnuplot # https://pypi.org/project/py-gnuplot/
import pandas as pd # https://pandas.pydata.org/docs/

# Main query template
selector = { "configurations.nodes": { "$elemMatch": { "operator": "OR", "cpe_match": { "$elemMatch": { "cpe23Uri": { "$regex": "linux_kernel" } } } } }, "publishedDate": { "$gte": "2020-01-01", "$lte": "2023-12-31" } }

fields = [ "cve.CVE_data_meta.ID" ]

sort = []

limit = 999999

gnuplot_qry_1 = {
}
#plot [2008.5:*] w boxes t 'All severities'

# 'out/1-linux-kernel-cves-by-year.tsv' u 1:($2+15):2 w labels t ''

parser = argparse.ArgumentParser(
    prog='tba',
    description='Tabulate Linux kernel CVEs from NVD imported into CouchDB.')

parser.add_argument('--start', '-s', help='Start year (inclusive)', default=2002, type=int)
parser.add_argument('--end', '-e', help='End year (inclusive)',  default=datetime.datetime.now().year, type=int)
# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)
parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')
parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')

global args
args = vars(parser.parse_args())


if __name__ == '__main__':

    server = f"http://{args['dbuser']}:{args['dbpass']}@localhost:5984"

    # WIP Must properly authenticate with IBMcloudant

    authenticator = BasicAuthenticator(f"{args['dbuser']}", f"{args['dbpass']}")
    service = CloudantV1(authenticator=authenticator)
    url = 'http://localhost:5984'
    service.set_service_url(f'{url}')
    #server_information = service.get_server_information().get_result()

    #print(f'Server Version: {server_information["version"]}')

    db_name = args['dbname']
    db_information = service.get_database_information(db=db_name).get_result()

    print(db_information["doc_count"])

    data_to_plot = {}

    x_year = list()
    y_cves = list()

    # Run query separately for each year
    for year in range(args['start'], args['end']+1):

        # Adjust query params
        selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel' # TODO Use this to add version
        selector['publishedDate']['$gte'] = f"{year!s}-01-01"
        selector['publishedDate']['$lte'] = f"{year!s}-12-31"
        #        print(qry)

        # Make the query
        print('Running query...')
        response = service.post_find(
            db=db_name,
            selector=selector,
            fields=fields,
            limit=limit
        ).get_result()

        #print(response['docs']) # TODO

        query_result_list = [r['cve']['CVE_data_meta']['ID'] for r in response['docs']]
        print(f'Result: {year}\t{len(query_result_list)}')

        x_year += [f'{year}']
        y_cves += [len(query_result_list)]

    # Use Panda df with Gnuplot
    df = pd.DataFrame({"cves": y_cves, "year": x_year})
    print(df)

    gnuplot.plot_data(df,
                      'using 3:2 with boxes t "All Severities"',
                      output = '"1-linux-kernel-cves-by-year.png"',
                      terminal = 'pngcairo font "arial,10"',
                      xrange = '[*:*]',
                      yrange = '[0:*]',
                      boxwidth = '0.8 relative',
                      style = 'fill solid 0.5',
                      xtics = '1',
                      autoscale = 'y',
                      title = '"Linux Kernel CVEs by Year"',
                      xlabel = '"Year"',
                      ylabel = '"Number of CVEs"',
                      key = 'top right'
                      )
