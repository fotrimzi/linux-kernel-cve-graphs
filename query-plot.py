#! /usr/bin/env python3
# Query CVE data in CouchDB database.
# Plot results with matplotlib

import argparse, datetime, json

from ibmcloudant.cloudant_v1 import CloudantV1
from ibm_cloud_sdk_core.authenticators import BasicAuthenticator

import matplotlib.pyplot as plt # https://matplotlib.org
import numpy as np # https://numpy.org/doc


# Main query template - Values replaced later
selector = { "configurations.nodes": { "$elemMatch": { "operator": "OR", "cpe_match": { "$elemMatch": { "cpe23Uri": { "$regex": "linux_kernel" } } } } }, "publishedDate": { "$gte": "YYYY-MM-DD", "$lte": "YYYY-MM-DD" } }
# Only key needed for counting
fields = [ "cve.CVE_data_meta.ID" ]
sort = []
limit = 999999

parser = argparse.ArgumentParser(
    prog='tba',
    description='Query CouchDB containing Linux kernel CVEs downloaded from NVD.')

parser.add_argument('--start', '-s', help='Start year (inclusive)', default=2002, type=int)
parser.add_argument('--end', '-e', help='End year (inclusive)',  default=datetime.datetime.now().year, type=int)
# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)
parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')
parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')

global args
args = vars(parser.parse_args())


if __name__ == '__main__':

    authenticator = BasicAuthenticator(f"{args['dbuser']}", f"{args['dbpass']}")
    service = CloudantV1(authenticator=authenticator)
    url = 'http://localhost:5984' # TODO use parameters
    service.set_service_url(f'{url}')
    # TODO Remove
    db_information = service.get_database_information(db=args['dbname']).get_result()
    print(f"{db_information['doc_count']} items in database")

    # TODO Loop around query types
    # Numbers from original article.
    # Versions from https://kernelnewbies.org/LinuxVersions

    # 1. Linux Kernel CVEs by Year
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"

    # 2. Linux Kernel CVEs by Year and Severity
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"
    #   selector['impact.baseMetricV2.severity'] = f"{sev!s}" # LOW | MEDIUM | HIGH

    # 3. and 4. Linux Kernel CVEs by Year and Version - 2.6.35-2.6.39 (2009-DATE), 3.0-3.19 (2011-DATE), 4.0-4.20 (2015-DATE), 5.0-5.19 (2019-DATE), 6.0-6.3 (2022-DATE)
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = f"linux_kernel:{vers}"
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"

    data = {} # { sev: [a, b, ..] } array of counts per year
    years = np.arange(args['start'], args['end']+1)
    sevs = ('LOW', 'MEDIUM', 'HIGH')

    # Run query separately for each year
    for sev in sevs:
        accumulator = list()
        for year in years:

            selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
            selector['publishedDate']['$gte'] = f"{year!s}-01-01"
            selector['publishedDate']['$lte'] = f"{year!s}-12-31"
            selector['impact.baseMetricV2.severity'] = f"{sev!s}"

            #print(f"Running query: {year!s} {sev}")

            response = service.post_find(
                db=args['dbname'],
                selector=selector,
                fields=fields,
                limit=limit
            ).get_result()

            query_result_list = [r['cve']['CVE_data_meta']['ID'] for r in response['docs']]
            #print(f'Result: {year}\t{sev}\t{len(query_result_list)}')

            accumulator += [len(query_result_list)]
            #print(accumulator)

        data[sev] = np.array(accumulator)
        #print(data)

    fig, ax = plt.subplots()
    bottom = np.zeros(len(years))

    for key, val in data.items():
        print(f"{key} - {val}")
        p = ax.bar(years, val, 0.5, label=key, bottom=bottom)
        bottom += val

    ax.set_title("Test")
    ax.legend(loc="upper right")

    plt.show()
    fig.savefig("test2.png")
