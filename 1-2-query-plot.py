#! /usr/bin/env python3
# Query CVE data in CouchDB database to show:
# 1. Linux kernel CVES by year
# 2. Linux kernel CVES by year and severity (LOW, MEDIUM, HIGH)

import argparse, datetime, json

from ibmcloudant.cloudant_v1 import CloudantV1
from ibm_cloud_sdk_core.authenticators import BasicAuthenticator

import matplotlib.pyplot as plt # https://matplotlib.org
import numpy as np # https://numpy.org/doc

# Mango query specification.
selector = { "configurations.nodes": { "$elemMatch": { "operator": "OR", "cpe_match": { "$elemMatch": { "cpe23Uri": { "$regex": "linux_kernel" } } } } }, "publishedDate": { "$gte": "YYYY-MM-DD", "$lte": "YYYY-MM-DD" } }
# Only key needed for counting
fields = [ "cve.CVE_data_meta.ID" ]
sort = []
limit = 999999

parser = argparse.ArgumentParser(
    prog='tba',
    description='Query CouchDB containing Linux kernel CVEs downloaded from NVD.')

parser.add_argument('--start', '-s', help='Start year (inclusive)', default=2002, type=int)
parser.add_argument('--end', '-e', help='End year (inclusive)',  default=datetime.datetime.now().year, type=int)
# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)
parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')
parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')

global args
args = vars(parser.parse_args())


if __name__ == '__main__':

    authenticator = BasicAuthenticator(f"{args['dbuser']}", f"{args['dbpass']}")
    service = CloudantV1(authenticator=authenticator)
    url = 'http://localhost:5984' # TODO use parameters
    service.set_service_url(f'{url}')
    # TODO Remove
    db_information = service.get_database_information(db=args['dbname']).get_result()
    print(f"{db_information['doc_count']} items in database")

    # TODO Loop around query types
    # Numbers from original article.
    # Versions from https://kernelnewbies.org/LinuxVersions

    # 1. Linux Kernel CVEs by Year
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"

    # 2. Linux Kernel CVEs by Year and Severity
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"
    #   selector['impact.baseMetricV2.severity'] = f"{sev!s}" # LOW | MEDIUM | HIGH

    # 1 and 2 can be combined by adding LOW + MEDIUM + HIGH values

    # 3. and 4. Linux Kernel CVEs by Year and Version - 2.6.35-2.6.39 (2009-DATE), 3.0-3.19 (2011-DATE), 4.0-4.20 (2015-DATE), 5.0-5.19 (2019-DATE), 6.0-6.3 (2022-DATE)
    #   selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = f"linux_kernel:{vers}"
    #   selector['publishedDate']['$gte'] = f"{year!s}-01-01"
    #   selector['publishedDate']['$lte'] = f"{year!s}-12-31"

    data = {} # { sev: [a, b, ..] } array of counts per year
    years = np.arange(args['start'], args['end']+1)
    sevs = ('LOW', 'MEDIUM', 'HIGH')

    # Run query separately for each year
    for sev in sevs:
        accumulator = list()
        for year in years:

            selector['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
            selector['publishedDate']['$gte'] = f"{year!s}-01-01"
            selector['publishedDate']['$lte'] = f"{year!s}-12-31"
            selector['impact.baseMetricV2.severity'] = f"{sev!s}"

            print(f"Running query: {year!s} {sev}")

            response = service.post_find(
                db=args['dbname'],
                selector=selector,
                fields=fields,
                limit=limit
            ).get_result()

            query_result_list = [r['cve']['CVE_data_meta']['ID'] for r in response['docs']]
            print(f'Result: {year}\t{sev}\t{len(query_result_list)}')

            accumulator += [len(query_result_list)]
            print(accumulator)

        data[sev] = np.array(accumulator)
        print(data)

    fig1, ax1 = plt.subplots()
    fig2, ax2 = plt.subplots()
    bottom = np.zeros(len(years))
    total_val = np.zeros(len(years))

    for key, val in data.items():
        print(f"{key} - {val}") # LOW - [ a b ..]

        # https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.bar.html#matplotlib.axes.Axes.bar

        # Axes.bar(x, height, width=0.8, bottom=None, *, align='center', data=None, **kwargs)


        p2 = ax2.bar(years, val, width=0.8, label=key, bottom=bottom)
        ax2.bar_label(p2, label_type='center')
        bottom += val
        total_val += val


    ax1.bar(years, total_val, width=0.8, tick_label=years)

    ax1.set_title("Linux kernel CVEs by Year")
    ax1.set_xlabel("Year")
    ax1.set_ylabel("Number of CVEs")
    ax1.legend(loc="upper left")
    fig1.savefig("1-linux-kernel-cves-by-year.png")

    ax2.set_title("Linux kernel CVEs by Severity")
    ax2.set_xlabel("Year")
    ax2.set_ylabel("Number of CVEs")
    ax2.legend(loc="upper left")
    fig2.savefig("2-linux-kernel-cves-by-year-and-severity.png")

    # https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.savefig.html#matplotlib.pyplot.savefig

    # fig.savefig(fname, *, dpi='figure', format=None, metadata=None, bbox_inches=None, pad_inches=0.1, facecolor='auto', edgecolor='auto', backend=None, **kwargs )
