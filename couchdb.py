#! /usr/bin/env python3
#
# Run CouchDB in docker.
#
# Equivalent command line:
# docker run -d -p 5984:5984 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password --name couchdb couchdb

import docker, argparse, sys

parser = argparse.ArgumentParser(
    prog='tba',
    description='Run CouchDB in Docker.')

# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)
parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')
parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')
parser.add_argument('--name', '-i', help='Docker instance name', default='couchdb')

global args
args = vars(parser.parse_args())

if __name__ == '__main__':
    print(f"Start Docker instance {args['instance']}...", end='')
    try:
        client = docker.from_env()
        the_container = client.containers.run('couchdb',
                                              name=f"{args['name']}",
                                              detach=True,
                                              auto_remove=True,
                                              environment=[f"COUCHDB_USER={args['dbuser']}",
                                                           f"COUCHDB_PASSWORD={args['dbpass']}"],
                                              ports={'5984/tcp': 5984})
        assert the_container.status == 'created', 'Docker failed'
    except:
        print(sys.exception())
        exit(1)

    print('Done')
    input('Press "Enter" to delete database, stop docker, and quit: ')
    the_container.stop() # Stop docker container
