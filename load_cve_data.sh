#!/usr/bin/env bash
# - Download CVE data files from NVD
# - Unzip them
# - Start a CouchDB instance with Docker
# - Create a database called 'nvd'
# - Use couchimport to load them into the nvd database
# - Check the counts of downloaded and imported

COUCHDB_USER=admin
COUCHDB_PASSWORD=password
COUCHDB_URL="http://${COUCHDB_USER}:${COUCHDB_PASSWORD}@localhost:5984"

# Used by couchimport
COUCH_DATABASE="nvd"
COUCH_FILETYPE="json"
COUCH_BUFFER_SIZE=100

# Download URL (version 1.1)
VERS=1.1
NVD_URL="https://nvd.nist.gov/feeds/json/cve/${VERS}/"

function couchdb_start() {
    docker run -d -p 5984:5984 -e COUCHDB_USER=${COUCHDB_USER} -e COUCHDB_PASSWORD=${COUCHDB_PASSWORD} --name couchdb couchdb &&
        docker ps
}

function couchdb_stop {
    docker stop couchdb
    docker rm couchdb
}

function create_db() {
    curl -X PUT http://${COUCHDB_URL}/${COUCH_DATABASE}
}

function download_cve_files() {
    FROM=$1
    TO=${2:-$(date +%Y)}

    for YEAR in $(seq ${FROM} ${TO})
    do
        FILE=$(printf "nvdcve-${VERS}-%s.json.gz" $YEAR)
        URL="${NVD_URL}${FILE}"
        echo "Downloading ${URL} to ${FILE}"
        curl ${URL} --output ${FILE} --progress-bar --retry 10 && gunzip ${FILE}
    done
}

function import_cve_files() {
    for f in $(ls -1 nvdcve*.json); do
        echo "Importing ${f}"
        cat ${f} | couchimport --jsonpath "CVE_Items.*"
    done
}

function count_downloaded_records() {
    grep CVE_data_numberOfCVEs nvdcve*.json | \
        cut -d':' -f3 | tr -cd '[:digit:][:cntrl:]' | \
        awk '{s+=$1} END {print s}'
}

function count_imported_records() {
    curl -sX GET ${COUCH_URL}/${COUCH_DATABASE} | jq '.doc_count'
}


#couchdb_start

mkdir download && pushd $_
download_cve_files 2020
popd

#couchdb_stop
