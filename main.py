#! /usr/bin/env python3
# Get CVE data (vers 1.1) from NVD, load into CouchDB running on localhost
# To run CouchDB with docker:
# docker run -d -p 5984:5984 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password --name couchdb couchdb

import requests, gzip, json, docker, argparse, datetime
import couchdb # For queries
from time2relax import CouchDB # For bulk loading https://pypi.org/project/time2relax/
from pygnuplot import gnuplot # https://pypi.org/project/py-gnuplot/
import pandas as pd # https://pandas.pydata.org/docs/

# Main query template. Used for queries:
# 1. Count of Linux kernel CVEs by year range
#    $regex = 'linux_kernel'
#    publishedDate.$gte = start date
#    publishedDate.$lte = end date
# 2. Count of Linux kernel CVEs by TODO
# 3. TODO
query_template = '''
{
        "selector": {
          "configurations.nodes": {
            "$elemMatch": {
              "operator": "OR",
              "cpe_match": {
                "$elemMatch": {
                  "cpe23Uri": {
                    "$regex": "linux_kernel"
                  }
                }
              }
            }
          },
          "publishedDate": {
            "$gte": "YYYY-MM-DD",
            "$lte": "YYYY-MM-DD"
          }
        },
        "fields": [
          "cve.CVE_data_meta.ID"
        ],
        "limit": 999999
}
'''

gnuplot_qry_1 = {
}
#plot [2008.5:*] w boxes t 'All severities'

# 'out/1-linux-kernel-cves-by-year.tsv' u 1:($2+15):2 w labels t ''

parser = argparse.ArgumentParser(
    prog='tba',
    description='Tabulate Linux kernel CVEs from NVD imported into CouchDB.')

parser.add_argument('--start', '-s', help='Start year (inclusive)', default=2002, type=int)
parser.add_argument('--end', '-e', help='End year (inclusive)',  default=datetime.datetime.now().year, type=int)

# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)

parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')

parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')
parser.add_argument('--instance', '-i', help='Docker CouchDB instance name', default='cvedb')

global args
args = vars(parser.parse_args())


def start_couchdb(name: str = args['instance'], u: str = args['dbuser'], p: str = args['dbpass']):
    """
    Start a docker container running CouchDB.
    """
    # TODO Check docker is running
    client = docker.from_env()
    return client.containers.run('couchdb', name=name, detach=True, auto_remove=True, environment=[f'COUCHDB_USER={u}', f'COUCHDB_PASSWORD={p}'], ports={'5984/tcp': 5984})


def make_batch(l, s):
    """
    Yields batch of size s from list l
    """
    for i in range(0, len(l), s):
        yield l[i : i + s]


def load_cve_data(url: str, db: CouchDB, start: int, end: int, vers: str = '1.1') -> None:
    """
    Download (vers) version json.gz files from NVD (url) for year range (start) to (end)
    and load into CouchDB (db).
    """
    for year in range(start, end+1):
        # TODO build url properly
        url_for_year = f'{url}/{vers}/nvdcve-{vers}-{year}.json.gz'
        batch_size = 100
        print(year)

        r = requests.get(url_for_year)
        # TODO Handle errors: timeout
        assert r.status_code == 200, f"Bad response code {r.status_code}"
        assert r.headers['content-type'] == 'application/x-gzip', 'Bad content type'
        json_content = gzip.decompress(r.content)
        json_content_object = json.loads(json_content)
        for batch in make_batch(json_content_object['CVE_Items'], batch_size):
            db.bulk_docs(batch)
            # TODO Check success


if __name__ == '__main__':
    """
    Control starts here
    """
    print(f"Start Docker instance {args['instance']}...", end='')
    couchdb_docker_container = start_couchdb(name=args['instance'])
    assert couchdb_docker_container.status == 'created', 'Docker failed'
    print('Done')

    # TODO Delete DB if already present?
    server = f"http://{args['dbuser']}:{args['dbpass']}@localhost:5984"

    # TODO Add to cmd line options
    nvd_url = "https://nvd.nist.gov/feeds/json/cve"
    sd = f"{server}/{args['dbname']}"
    db = CouchDB(sd, create_db=True)

    print('Load data into CouchDB')
    load_cve_data(url = nvd_url, db = db, start = args['start'], end = args['end'])
    print('Done')

    # Load the query template as a JSON structure.
    qry = json.loads(query_template)

    # Open server for querying
    query_server = couchdb.client.Server(server)
    query_database = query_server[args['dbname']]

    data_to_plot = {}

    print('Running query...')
    x_year = list()
    y_cves = list()
    for year in range(args['start'], args['end']+1):
        qry['selector']['configurations.nodes']['$elemMatch']['cpe_match']['$elemMatch']['cpe23Uri']['$regex'] = 'linux_kernel'
        qry['selector']['publishedDate']['$gte'] = f"{year!s}-01-01"
        qry['selector']['publishedDate']['$lte'] = f"{year!s}-12-31"
        #        print(qry)

        query_result_list = [r['cve']['CVE_data_meta']['ID'] for r in query_database.find(qry)]
        print(f'Result: {year}\t{len(query_result_list)}')

        x_year += [f'{year}']
        y_cves += [len(query_result_list)]

    # Use Panda df with Gnuplot
    df = pd.DataFrame({"cves": y_cves, "year": x_year})
    print(df)

    gnuplot.plot_data(df,
                      'using 3:2 with boxes t "All Severities"',
                      output = '"1-linux-kernel-cves-by-year.png"',
                      terminal = 'pngcairo font "arial,10"',
                      xrange = '[*:*]',
                      yrange = '[0:*]',
                      boxwidth = '0.8 relative',
                      style = 'fill solid 0.5',
                      xtics = '1',
                      autoscale = 'y',
                      title = '"Linux Kernel CVEs by Year"',
                      xlabel = '"Year"',
                      ylabel = '"Number of CVEs"',
                      key = 'top right'
                      )

    input('Press "Enter" to delete database, stop docker, and quit: ')
    couchdb_docker_container.stop() # Stop docker container
