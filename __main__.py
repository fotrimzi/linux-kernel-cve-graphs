#! /usr/bin/env python3

# https://requests.readthedocs.io/
import requests, gzip, json
# https://pypi.org/project/time2relax/
from time2relax import CouchDB
import couchdb




def generate_batch(lst, batch_size):
    """
    Yields batch of specified size
    Used to send batch of CVEs to CouchDB
    """
    for i in range(0, len(lst), batch_size):
        yield lst[i : i + batch_size]

def load_cve_data(url: str, db: CouchDB, start = 2002, end = 2023, vers: str = '1.1') -> None:
    '''
    TODO end year default to current
    Make requests to NVD for CVE data
    Read content into memory and unzip
    Load into CouchDB in batches
    '''
    for year in range(start, end):
        # TODO build url properly
        url_for_year = f"{url}/{vers}/nvdcve-{vers}-{year}.json.gz"
        print(f"Loading data for {year}")

        r = requests.get(url_for_year)
        assert r.status_code == 200, "Bad response code"
        assert r.headers['content-type'] == 'application/x-gzip', "Bad content type"
        json_content = gzip.decompress(r.content)
        json_content_object = json.loads(json_content)
        cve_items = json_content_object['CVE_Items']
        batched_cve_items = generate_batch(cve_items, 100)
        for batch in batched_cve_items:
            db.bulk_docs(batch)

if __name__ == '__main__':
    # TODO Delete DB if already present?
    server = 'http://admin:password@localhost:5984'
    database = 'nvd'
    sd = f'{server}/{database}'

    db = CouchDB(sd, create_db=True)

    url = "https://nvd.nist.gov/feeds/json/cve"

    load_cve_data(url=url, db=db)

    # TODO analyse data in CouchDB

    # Load queries from JSON file. Access query by key (e.g. query_0)
    query_file = 'queries.json'
    queries = json.loads(pathlib.Path(query_file).read_text())
    query_server = couchdb.client.Server(server)
    query_name = 'query_0'
    query_database = query_server[database]

    print(f"Running query {query_name}")
    query_result = query_database.find(queries[query_name])
    count = 0
    for r in query_result:
        count+=1
        print(f"{count} ",  r['cve']['CVE_data_meta']['ID'])


    # Or with list comprehension
    query_result_list = [r['cve']['CVE_data_meta']['ID'] for r in query_result]
    print(len(query_result_list))






    #    db.destroy()
