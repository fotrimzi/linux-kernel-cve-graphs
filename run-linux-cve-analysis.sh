#! /usr/bin/env bash
# Script to chart Linux kernel CVEs for kernel versions
# 3.x, 4.x, 5.x.
# You must have loaded a CouchDB database with CVE
# data as described here:
# https://blog.kernelcare.com/linux-kernel-cve-data-analysis-part-1-importing-into-couchdb

# Parallel arrays for Linux kernel versions:
# 3.0-3.19 (2011-DATE)
# 4.0-4.20 (2015-DATE)
# 5.0-5.12 (2019-DATE)
VERS_MAJOR=(3 4 5)
VERS_MINOR_START=(0 0 0)
VERS_MINOR_STOP=(19 20 12)
YEAR_START=(2011 2015 2019)

YEAR_STOP=$(date +%Y)
# admin/password are CouchDB admin login credentials
COUCHDB_URL="http://admin:password@localhost:5984/nvd/_find"

QRY="3-linux-kernel-cves-by-year-and-version"

##
# Construct version string from args
# and set VERSIONS.
# Args:
# 1: Major version number
# 2: Minor version start number
# 3: Minor version stop number
build_versions() {
    VERSIONS=()
    for VERS_MINOR in $(seq ${2} ${3}); do
        VERSIONS+=(${1}.${VERS_MINOR})
    done
}

##
# Write a query file to qry subdir
# Args:
# 1: Name of query file without extension
write_query() {
cat<<\EOF>qry/${1}.json
{
    "selector": {
        "configurations.nodes": {
            "$elemMatch": {
                "operator": "OR",
                "cpe_match": {
                    "$elemMatch": {
                        "cpe23Uri": {
                            "$regex": "linux_kernel:%s"
                        }
                    }
                }
            }
        },
        "publishedDate": {
            "$gte": "%s-01-01",
            "$lte": "%s-12-31"
        }
    },
    "fields": [
        "cve.CVE_data_meta.ID"
    ],
    "limit": 999999
}
EOF
}

##
# Run the query
#
run_query() {
    (IFS=$'\t'; echo -e "\t${VERSIONS[*]}" | tee out/${OUT}.tsv); \
    for Y in $(seq ${YEAR_START[$i]} ${YEAR_STOP}); do
        RES=()
        echo -en "${Y}\t"
        for V in ${VERSIONS[*]}; do
            RES+=($(printf "$(cat qry/${QRY}.json)" ${V} ${Y} ${Y} \
            | curl -sX POST -d @- ${COUCHDB_URL} \
            --header "Content-Type:application/json" \
            | jq '.docs | length'))
        done
    (IFS=$'\t'; echo "${RES[*]}")
    done | tee -a out/${OUT}.tsv
}

# Run a gnuplot script with values supplied
# by:
# 1: Base of filename
# 2: Major version number
# 3: As per 1
run_gnuplot() {

printf '
reset
set terminal png size 800,600
set output "img/%s.png"
set xtics 1
set key top right autotitle columnheader title "Kernel Version"
set title "Linux kernel CVEs by version %s.x"
set xlabel "Year"
set ylabel "Number of CVEs"
set autoscale y
plot [] [] for [c=2:*] "out/%s.tsv" using 1:c with lines lw 3
' $1 $2 $1 | gnuplot -
}

main() {
    write_query ${QRY}

    for i in 0 1 2; do
        build_versions ${VERS_MAJOR[$i]} ${VERS_MINOR_START[$i]} ${VERS_MINOR_STOP[$i]}
        OUT="${QRY}_${VERS_MAJOR[$i]}.x"
        run_query
        run_gnuplot $OUT ${VERS_MAJOR[$i]}
    done
}

main
