#! /usr/bin/env python3
# Run a Mango query, load results into hashes, dump them into text files
# Install:
# - couchdb
# - pip install -r requirements
import argparse, csv, datetime, inspect, json, os, re, requests, sys, urllib3
from collections import defaultdict
from lxml import etree
from io import BytesIO

##
# Parse command line arguments and set up globals
#
parser = argparse.ArgumentParser(description='Tabulate Linux kernel CVEs from NVD imported into CouchDB.')
parser.add_argument('--dbaddr',          help='Local CouchDB address',        default='http://admin:password@127.0.0.1')
parser.add_argument('--dbname',          help='CouchDB database',             default='nvd')
parser.add_argument('--dbport',          help='Local CouchDB port number',    default='5984',                       type=int)
parser.add_argument('--queryfile',       help='Mango query template file',    default='payload.json')
parser.add_argument('--kvfeed',          help='Kernel versions XML feed URL', default='https://www.kernel.org/feeds/kdist.xml')
parser.add_argument('--basescoremin',    help='Minimum base score value',     default=0,                            type=int)
parser.add_argument('--basescoremax',    help='Maximum base score value',     default=10,                           type=int)
parser.add_argument('--startyr',         help='Start year (inclusive)',       default=2002,                         type=int)
parser.add_argument('--endyr',           help='End year (inclusive)',         default=datetime.datetime.now().year, type=int)
parser.add_argument('--numvers',         help='Number of versions',           default=10,                           type=int)
parser.add_argument('--reportprefix',    help='Output filename prefix',       default='nvd_')
parser.add_argument('--reportsuffix',    help='Output filename suffix',
                    default='_' + datetime.datetime.isoformat(datetime.datetime.now()) + '.txt')
parser.add_argument('--report',          help='Report',                       default='count_matrix',
                    choices=['count_matrix', 'count_list', 'id', 'severity'])
parser.add_argument('--states',          help='Linux kernel states',          default='stable,longterm')
parser.add_argument('versions',nargs='*',help='Linux kernel versions (X.Y.Z)',default=[])
parser.add_argument('--verbose','-v',    help='Verbose', action='store_true')

###
# Globals
#
args = vars(parser.parse_args())
# Mango query results loaded into these before tabulating.
cve_counts   = defaultdict(dict) # [vers][year] = number of CVEs
cve_idents   = defaultdict(dict) # [vers][year] = [CVE IDs]

years = range(args['startyr'], args['endyr']+1)
versions = args['versions']

##
# Convenience functions
#
def logme(txt): # stdout logging function
  if args['verbose']:
    print(txt)

def report_desc(): # Report file description header
    return("CVE query range: years [%s] versions [%s] severity [%d-%d]\n\n" %
      (", ".join(map(str,years)), ", ".join(versions), args['basescoremin'], args['basescoremax']))

##
# Get current kernel versions from kernel.org
#
def get_versions():
  vers=[]
  http=urllib3.PoolManager()
  r=http.request('GET',args['kvfeed'])
  ctx=etree.iterparse(BytesIO(r.data),tag="title")
  states=args['states'].split(',') # Only specified states

  for a,t in ctx:
    for s in states:
      if re.search(s,t.text):
        v=t.text.split(':')[0]
        vers+=[v]

  return vers

##
# Expand v (list of versions in X.Y.Z form) from Z down to 0 (or max count n)
#
def expand_versions(vers, n=args['numvers']):
  expanded_versions=[]

  for v in vers:
    m=n
    vbits=v.split('.')
    mj=vbits[0]
    mn=vbits[1]
    pt=int(vbits[-1])

    while pt>=0 and m>0:
      expanded_versions+=[mj + '.' + mn + '.' + str(pt)]
      pt-=1
      m-=1

  return expanded_versions

##
# Add parameters to Mango query (queryfile used as payload)
# and use it to query CouchDB, inserting results into dictionaries.
#
def setup():
  global versions
  if not versions: # Get from feed if not supplied as args
    versions = get_versions()

  versions = expand_versions(versions)
  logme("CVE query range: years: [" + ", ".join(map(str,years)) + "], versions: [" + ", ".join(versions) + "]")
  dburl = args['dbaddr'] + ':' + str(args['dbport']) + '/' + args['dbname'] + '/' + '_find/'
  headers = {'content-type': 'application/json', 'Accept-Charset': 'UTF-8'}
  with open(os.path.join(os.getcwd(), args['queryfile']), 'r') as plfile:
    mango_query_template = plfile.read()

  for y in years:
    for v in versions:
      # Values for query template (payload)
      payload = mango_query_template % (v, y, y, args['basescoremin'], args['basescoremax'])
      r = requests.post(dburl, data=payload, headers=headers)
      x = json.loads(r.text)
      cve_counts[v][y] = len(x['docs'])
      logme("%d\t%-10s\t%d CVEs" % (y, v, cve_counts[v][y]))
      # For id report
      ids=[]
      for c in x['docs']:
        ids.append(c['cve']['CVE_data_meta']['ID'])
        cve_idents[v][y] = ids

##
# Report: Tabulate CVE counts, Years vs Version
#
def rep_cve_count_matrix():
  f = open(args['reportprefix'] + inspect.currentframe().f_code.co_name + args['reportsuffix'], 'w')
  # Header
  f.write(report_desc())
  f.write("%10s" % "")
  for y in years:
    f.write("%-10s" % y)
  f.write("\n")
  # Data
  for v in sorted(cve_counts,key=lambda s: [int(u) for u in s.split('.')],reverse=True):
    f.write("%-10s" % v)
    for y in years:
      f.write("%-10s" % str(cve_counts[v][y]))
    f.write("\n")

  f.close()
  return(f)

##
# Report: Tabulate as [Maj,Vers,Year,Count]
#
def rep_cve_count_list():
  f=open(args['reportprefix'] + inspect.currentframe().f_code.co_name + args['reportsuffix'], 'w')
  # Header
  f.write(report_desc())
  f.write("%s\t%s\t%s\t%s\n" % ('Major','Vers','Year','Count'))
  # Data
  for kv in sorted(cve_counts, key = lambda s:[int(u) for u in s.split('.')], reverse=True):
    for ky in years:
      f.write("%s\t%s\t%s\t%s\n" % (kv.split('.')[0] + '.' + kv.split('.')[1], kv, ky, cve_counts[kv][ky]))

  f.close()
  return(f)

##
# Report: List of [version, year, CVE ID]
#
def rep_cve_id():
  f=open(args['reportprefix'] + inspect.currentframe().f_code.co_name + args['reportsuffix'], 'w')
  # Header
  f.write(report_desc())
  # Data
  for vers in sorted(cve_idents, key = lambda s:[int(u) for u in s.split('.')]): #, reverse=True):
    for year in sorted(cve_idents[vers]):
      for cveid in cve_idents[vers][year]:
        f.write(",".join([vers, str(year), cveid]) + "\n")

  f.close()
  return(f)

###
# Entry
#
if __name__ == '__main__':
  setup()
  sys.stdout.write("Report file: ")

  if args['report'] == 'count_matrix':
    print(rep_cve_count_matrix().name)

  if args['report'] == 'count_list':
    print(rep_cve_count_list().name)

  if args['report'] == 'id':
    print(rep_cve_id().name)

  exit(0)
