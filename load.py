#! /usr/bin/env python3
# Get CVE data (vers 1.1) from NVD, load into CouchDB running on localhost
# Check load via CouchDB UI at http://localhost:5984/_utils/#login

import requests, gzip, json, argparse, datetime, sys
from time2relax import CouchDB # For bulk loading https://pypi.org/project/time2relax/

parser = argparse.ArgumentParser(
    prog='tba',
    description='Download CVE data from NVD and import into CouchDB.')

parser.add_argument('--start', '-s', help='Start year (inclusive)', default=2002, type=int)
parser.add_argument('--end', '-e', help='End year (inclusive)',  default=datetime.datetime.now().year, type=int)
# parser.add_argument('--dbport', help='Local CouchDB port number', default='5984', type=int)
parser.add_argument('--dbuser', '-u', help='CouchDB admin username', default='admin')
parser.add_argument('--dbpass', '-p', help='CouchDB admin password', default='password')
parser.add_argument('--dbname', '-n', help='CouchDB database name', default='nvd')

global args
args = vars(parser.parse_args())

def make_batch(l, s):
    """
    Yields batch of size s from list l
    """
    for i in range(0, len(l), s):
        yield l[i : i + s]


def load_cve_data(url: str, db: CouchDB, start: int, end: int, vers: str = '1.1') -> None:
    """
    Download (vers) version json.gz files from NVD (url) for year range (start) to (end)
    and load into CouchDB (db).
    """
    for year in range(start, end+1):
        # TODO build url properly
        url_for_year = f'{url}/{vers}/nvdcve-{vers}-{year}.json.gz'
        batch_size = 100
        print(year)

        r = requests.get(url_for_year)
        # TODO Handle errors: timeout
        assert r.status_code == 200, f"Bad response code {r.status_code}"
        assert r.headers['content-type'] == 'application/x-gzip', 'Bad content type'
        json_content = gzip.decompress(r.content)
        json_content_object = json.loads(json_content)
        for batch in make_batch(json_content_object['CVE_Items'], batch_size):
            db.bulk_docs(batch)
            # TODO Check success


if __name__ == '__main__':
    # TODO Delete DB if already present?
    server = f"http://{args['dbuser']}:{args['dbpass']}@localhost:5984"

    # TODO Add to cmd line options
    nvd_url = "https://nvd.nist.gov/feeds/json/cve"
    sd = f"{server}/{args['dbname']}"
    db = CouchDB(sd, create_db=True)

    print('Load data into CouchDB') # TODO add some info about which server
    load_cve_data(url = nvd_url, db = db, start = args['start'], end = args['end'])

    # TODO Query and count number of docs
    print('Done')
